generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model Slot {
  id        String     @id @default(cuid())
  startTime DateTime   @unique
  duration  Int
  holdUntil DateTime?
  holdKey   String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  status    SlotStatus @default(free)
  session   Session?   @relation("SlotSession")

  @@index([startTime])
  @@index([status, startTime, holdUntil])
  @@index([holdKey, holdUntil])
}

model AvailabilityRule {
  id            String   @id @default(cuid())
  weekday       Int      @unique
  openMinute    Int
  closeMinute   Int
  effectiveFrom DateTime @default(now())
  createdAt     DateTime @default(now())
}

model AvailabilityException {
  id          String   @id @default(cuid())
  date        DateTime
  openMinute  Int?
  closeMinute Int?
  blocked     Boolean  @default(false)

  @@index([date])
}

model Session {
  id               String      @id @default(cuid())
  sessionType      String
  status           String      @default("unpaid")
  slotId           String?     @unique
  liveMinutes      Int
  followups        Int         @default(0)
  riotTag          String
  notes            String?
  createdAt        DateTime    @default(now())
  paymentProvider  String?
  paymentRef       String?     @unique
  amountCents      Int?
  currency         String      @default("eur")
  blockCsv         String?
  scheduledStart   DateTime
  scheduledMinutes Int
  liveBlocks       Int         @default(0)
  waiverAccepted   Boolean     @default(false)
  waiverAcceptedAt DateTime?
  waiverIp         String?
  studentId        String?
  discordId        String?
  discordName      String?
  slot             Slot?       @relation("SlotSession", fields: [slotId], references: [id])
  student          Student?    @relation(fields: [studentId], references: [id])
  sessionDoc       SessionDoc? @relation("SessionToDoc")
  couponCode      String?
  couponDiscount  Int         @default(0)


  @@index([createdAt])
  @@index([scheduledStart])
  @@index([riotTag])
  @@index([discordId])
  @@index([studentId])
}

model ProcessedEvent {
  id        String   @id
  createdAt DateTime @default(now())

  @@index([createdAt])
}

model WebhookEvent {
  id        String   @id @default(cuid())
  type      String
  payload   Json?
  createdAt DateTime @default(now())

  @@index([type, createdAt])
}

model Student {
  id            String         @id @default(cuid())
  name          String         @unique
  puuid         String?        @unique
  server        String?
  riotTag       String?        @unique
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  discordId     String?        @unique
  discordName   String?
  rankSnapshots RankSnapshot[]
  sessions      Session[]
  sessionDocs   SessionDoc[]
  assets        StudentAsset[]
    coupons       Coupon[]        


  @@index([puuid])
}

model AssetLibrary {
  id         String         @id @default(cuid())
  name       String
  type       String
  storageKey String
  url        String
  mime       String?
  size       Int?
  createdAt  DateTime       @default(now())
  students   StudentAsset[]
}

model StudentAsset {
  id        String       @id @default(cuid())
  studentId String
  assetId   String
  createdAt DateTime     @default(now())
  asset     AssetLibrary @relation(fields: [assetId], references: [id], onDelete: Cascade)
  student   Student      @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, assetId])
  @@index([studentId])
  @@index([assetId])
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model RankSnapshot {
  id         String   @id @default(cuid())
  studentId  String
  capturedAt DateTime @default(now())
  tier       String
  division   String?
  lp         Int
  student    Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId, capturedAt])
  @@index([capturedAt])
}

model SessionDoc {
  id        String   @id @default(cuid())
  studentId String
  number    Int
  notes     Json     @default("{}")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  sessionId String?  @unique
  session   Session? @relation("SessionToDoc", fields: [sessionId], references: [id])
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, number])
  @@index([studentId])
  @@index([sessionId])
}

enum SlotStatus {
  free
  taken
  blocked
}

model Coupon {
  id         String   @id @default(cuid())
  code       String   @unique
  studentId  String
  value      Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  student    Student  @relation(fields: [studentId], references: [id])

  @@index([studentId])
}
